<AppBarModifier title="Requests"/>
<div class="result">
  {#if !downloadFinished}
  <div class="place-holder">
    SEM IMAGEM
  </div>
  {:else}
    {#await loadImagePromise}
      <div class="loading">
        <CircularProgress speed="7" height="50"/>
      </div>
    {:then}
      <img src={resImageUrl} alt="result-image"/>
    {:catch}
      Error Loading Image.
    {/await}
  {/if}
</div>

<PromisedDialog
  promise={requestPromise}
  on:success="loadImageFromData()"
  on:failure="console.log(event)" ref:dialog>
  {#await requestPromise}
    Request API Data . . .
  {:then}
    Data Loaded !
  {:catch}
    Data Request Failed :(
  {/await}
</PromisedDialog>

<div class="btn-wrapper">
  <Button on:click="requestApiData()">
    Carregar Imagem
  </Button>
</div>

<script>
  import http from '@mamba/pos/api/http.js';

  export default {
    components: {
      AppBarModifier: '@mamba/appbar/Modifier.html',
      Button: '@mamba/button',
      PromisedDialog: '@mamba/dialog/Promised.html',
      CircularProgress: '@mamba/progress/Circular.html',
    },
    data() {
      return {
        requestConfig: {
          url: 'https://api.thecatapi.com/v1/images/search?size=med&',
          headers: {
            'Content-Type': 'application/json;charset=UTF-8',
            'Cache-Control': 'no-cache',
            Authorization:
              'CDBDE4E6DC4E6AC1845606D0720BAFA557FA046347876CAA3986872AC1123852',
          },
          method: 'GET',
          connect: 'DEV',
        },
        downloadFinished: false,
        resImageUrl: '',
        requestPromise: null,
        loadImagePromise: null,
        data: null,
      };
    },
    methods: {
      requestApiData() {
        const { requestConfig } = this.get(); // get requestConfig props
        this.set({
          downloadFinished: false,
          // starting the request, so downloadFinished is false
          requestPromise: http
            .send(requestConfig)
            .then(result =>
              this.set({ data: JSON.parse(result)[0], downloadFinished: true }),
            ),
        });
      },
      loadImageFromData() {
        this.set({
          loadImagePromise: new Promise((resolve, reject) => {
            const { data } = this.get();
            console.log('load');
            const tempImg = new Image(); // new image to receive url image
            tempImg.src = data.url;
            tempImg.onload = () => {
              this.set({ resImageUrl: data.url }); // loads image
              resolve();
            };
            tempImg.onerror = () => reject();
          }),
        });
      },
    },
  };
</script>

<style type="text/postcss">
  .btn-wrapper {
    display: block;
    position: fixed;
    bottom: 10px;
    width: 100%;
    text-align: center;
  }

  .result {
    display: block;
    width: 120px;
    height: 120px;
    margin: 40px auto;
    overflow: hidden;
  }

  .result .place-holder {
    display: block;
    text-align: center;
    padding-top: 40px;
    color: gray;
    width: 120px;
    height: 120px;
    border: dashed gray;
    margin: 0 auto;
  }

  .result img,
  .loading {
    display: block;
    text-align: center;
    padding-top: 40px;
    width: 120px;
    max-height: 120px;
    margin: 0 auto;
  }
</style>
